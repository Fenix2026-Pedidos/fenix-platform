{% extends 'base.html' %}
{% load i18n %}

{% block page_title %}
    {% if lang == 'zh-hans' %}{{ product.name_zh_hans }}{% else %}{{ product.name_es }}{% endif %}
{% endblock %}
{% block title %}
    {% if lang == 'zh-hans' %}{{ product.name_zh_hans }}{% else %}{{ product.name_es }}{% endif %} - Fenix
{% endblock %}

{% block content %}
<nav style="margin-bottom: 24px;">
    <ol style="display: flex; list-style: none; padding: 0; gap: 8px; align-items: center;">
        <li><a href="{% url 'catalog:product_list' %}" style="color: var(--primary-600); text-decoration: none;">{% trans "Catálogo" %}</a></li>
        <li><i class="bi bi-chevron-right" style="color: var(--gray-400);"></i></li>
        <li style="color: var(--gray-600);">
            {% if lang == 'zh-hans' %}{{ product.name_zh_hans }}{% else %}{{ product.name_es }}{% endif %}
        </li>
    </ol>
</nav>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
    <div>
        {% if product.image %}
        <div style="width: 100%; max-height: 500px; overflow: hidden; border-radius: var(--radius-md); margin-bottom: 24px; background: var(--gray-100); display: flex; align-items: center; justify-content: center;">
            <img src="{{ product.image.url }}" alt="{% if lang == 'zh-hans' %}{{ product.name_zh_hans }}{% else %}{{ product.name_es }}{% endif %}" 
                 style="width: 100%; height: auto; object-fit: contain; max-height: 500px;">
        </div>
        {% else %}
        <div style="width: 100%; height: 400px; border-radius: var(--radius-md); margin-bottom: 24px; background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%); display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-image" style="font-size: 64px; color: var(--gray-400);"></i>
        </div>
        {% endif %}
        
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 24px; color: var(--gray-900);">
            {% if lang == 'zh-hans' %}
                {{ product.name_zh_hans }}
            {% else %}
                {{ product.name_es }}
            {% endif %}
        </h1>
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">{% trans "Descripción" %}</h5>
            </div>
            <div class="card-body">
                <p style="color: var(--gray-700); line-height: 1.8;">
                    {% if lang == 'zh-hans' %}
                        {{ product.description_zh_hans|default:"Sin descripción disponible."|linebreaks }}
                    {% else %}
                        {{ product.description_es|default:"Sin descripción disponible."|linebreaks }}
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div>
        <div class="card" style="position: sticky; top: 90px;">
            <div class="card-body">
                <div style="text-align: center; margin-bottom: 24px; padding: 24px; background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%); border-radius: var(--radius-md);">
                    <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">{% trans "Precio" %}</div>
                    <div style="font-size: 36px; font-weight: 700; color: var(--primary-600);">{{ product.price|floatformat:2 }} €</div>
                </div>
                
                {% if user.is_authenticated %}
                <form id="add-to-cart-form">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.pk }}">
                    <div class="form-group">
                        <label class="form-label">{% trans "Cantidad" %}</label>
                        <input type="number" id="quantity" name="quantity" class="form-control" 
                               value="1" min="1" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-cart-plus"></i> {% trans "Añadir al Carrito" %}
                    </button>
                </form>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    {% trans "Debes iniciar sesión para añadir productos al carrito." %}
                    <div style="margin-top: 12px;">
                        <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-sm" style="width: 100%;">
                            {% trans "Iniciar Sesión" %}
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('add-to-cart-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        product_id: formData.get('product_id'),
        quantity: parseInt(formData.get('quantity'))
    };
    
    try {
        const response = await fetch('{% url "orders:cart_add" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '90px';
            alertDiv.style.right = '24px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> ${result.message}
                <button type="button" onclick="this.parentElement.remove()" style="background: none; border: none; float: right; cursor: pointer; font-size: 18px;">&times;</button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
            setTimeout(() => location.reload(), 500);
        } else {
            alert(result.message || '{% trans "Error al añadir al carrito" %}');
        }
    } catch (error) {
        alert('{% trans "Error al añadir al carrito" %}');
    }
});
</script>
{% endblock %}
