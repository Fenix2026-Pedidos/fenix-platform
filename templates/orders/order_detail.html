{% extends 'base.html' %}
{% load i18n %}
{% load orders_filters %}

{% block page_title %}{% trans "Pedido" %} #{{ order.id }}{% endblock %}
{% block title %}{% trans "Pedido" %} #{{ order.id }} - Fenix{% endblock %}

{% block content %}
<!-- Breadcrumb + Print Button -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <nav>
        <ol style="display: flex; list-style: none; padding: 0; gap: 8px; align-items: center;">
            <li><a href="{% url 'orders:order_list' %}" style="color: var(--primary-600); text-decoration: none;">{% trans "Mis Pedidos" %}</a></li>
            <li><i class="bi bi-chevron-right" style="color: var(--gray-400);"></i></li>
            <li style="color: var(--gray-600);">{% trans "Pedido" %} #{{ order.id }}</li>
        </ol>
    </nav>
    
    <div style="display: flex; gap: 12px; align-items: center;">
        {% if can_cancel_user %}
        <button type="button" class="btn btn-danger" style="display: flex; align-items: center; gap: 8px;" onclick="openCancelModal();">
            <i class="bi bi-x-circle"></i>
            <span>{% trans "Cancelar Pedido" %}</span>
        </button>
        {% elif cancel_disabled_reason %}
        <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
            <button disabled class="btn" style="display: flex; align-items: center; gap: 8px; opacity: 0.5; cursor: not-allowed;" title="{{ cancel_disabled_reason }}">
                <i class="bi bi-x-circle"></i>
                <span>{% trans "Cancelar Pedido" %}</span>
            </button>
            <span style="font-size: 12px; color: var(--gray-500); text-align: right;">
                {{ cancel_disabled_reason }}
            </span>
        </div>
        {% endif %}

        <button onclick="window.print()" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px;">
            <i class="bi bi-printer"></i>
            <span>{% trans "Imprimir" %}</span>
        </button>
    </div>
</div>

<!-- Header: Order Number + Status -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 24px;">
        <div>
            <h2 style="margin: 0; font-size: 28px; color: var(--gray-900);">
                {% trans "Pedido" %} #{{ order.id }}
            </h2>
            <p style="margin: 8px 0 0 0; color: var(--gray-500);">
                {% trans "Fecha de creación:" %} {{ order.created_at|date:"d/m/Y H:i" }}
            </p>
        </div>
        <span class="status-badge status-{{ order.status }}" style="font-size: 16px; padding: 8px 16px;">
            {{ order.get_status_display }}
        </span>
    </div>
</div>

<!-- CARD: Información del Pedido (Cliente + Entrega + Datos Pedido) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Información del Pedido" %}</h5>
    </div>
    <div class="card-body" style="padding: 24px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 32px;">
            <!-- COLUMNA 1: Información del Cliente -->
            <div>
                <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                    {% trans "INFORMACIÓN DEL CLIENTE" %}
                </h6>
                <dl style="display: grid; gap: 12px; margin: 0;">
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Cliente" %}
                        </dt>
                        <dd style="font-weight: 600; margin: 0;">
                            {% if customer.full_name %}
                                {{ customer.full_name }}
                            {% elif customer.first_name or customer.last_name %}
                                {{ customer.first_name }} {{ customer.last_name }}
                            {% else %}
                                {{ customer.email }}
                            {% endif %}
                        </dd>
                    </div>
                    
                    {% if customer.company %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Empresa" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.company }}</dd>
                    </div>
                    {% endif %}
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Email" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.email }}</dd>
                    </div>
                    
                    {% if customer.telefono_empresa %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Teléfono Empresa" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.telefono_empresa }}</dd>
                    </div>
                    {% endif %}
                    
                    {% if customer.telefono_reparto %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Teléfono Reparto/Incidencias" %}
                        </dt>
                        <dd style="margin: 0; font-weight: 600; color: var(--primary-600);">
                            {{ customer.telefono_reparto }}
                        </dd>
                    </div>
                    {% endif %}
                </dl>
            </div>

            <!-- COLUMNA 2: Datos del Pedido -->
            <div>
                <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                    {% trans "DATOS DEL PEDIDO" %}
                </h6>
                <dl style="display: grid; gap: 12px; margin: 0;">
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Nº Pedido / ID" %}
                        </dt>
                        <dd style="font-weight: 600; color: var(--primary-600); font-size: 18px; margin: 0;">
                            #{{ order.id }}
                        </dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Fecha de Creación" %}
                        </dt>
                        <dd style="margin: 0;">{{ order.created_at|date:"d/m/Y H:i" }}</dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Fecha de Entrega" %}
                        </dt>
                        <dd style="margin: 0;">
                            {% if order.delivered_at %}
                                {{ order.delivered_at|date:"d/m/Y H:i" }}
                            {% else %}
                                <span style="color: var(--gray-400);">—</span>
                            {% endif %}
                        </dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Estado" %}
                        </dt>
                        <dd style="margin: 0;">
                            <span class="status-badge status-{{ order.status }}">
                                {{ order.get_status_display }}
                            </span>
                        </dd>
                    </div>
                </dl>
            </div>

            <!-- COLUMNA 3: Dirección de Entrega -->
            <div>
                <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                    {% trans "DIRECCIÓN DE ENTREGA" %}
                </h6>
                <dl style="display: grid; gap: 12px; margin: 0;">
                    {% if customer.ciudad %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Ciudad" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.ciudad }}</dd>
                    </div>
                    {% endif %}
                    
                    {% if customer.direccion_entrega %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Dirección" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.direccion_entrega }}</dd>
                    </div>
                    {% elif customer.direccion_local %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Dirección" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.direccion_local }}</dd>
                    </div>
                    {% endif %}
                    
                    {% if order.eta_start and order.eta_end %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Ventana de Entrega" %}
                        </dt>
                        <dd style="margin: 0;">
                            {{ order.eta_start|date:"d/m/Y H:i" }} - {{ order.eta_end|date:"H:i" }}
                        </dd>
                    </div>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- CARD: Detalles del Pedido (Tabla de Líneas) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Detalles del Pedido" %}</h5>
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th style="text-align: center;">{% trans "ID Pedido" %}</th>
                    <th>{% trans "Producto" %}</th>
                    <th style="text-align: center;">{% trans "Cantidad" %}</th>
                    <th style="text-align: right;">{% trans "Precio Unitario" %}</th>
                    <th style="text-align: right;">{% trans "Total Línea" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td style="text-align: center; color: var(--gray-500); font-size: 13px;">
                        #{{ order.id }}
                    </td>
                    <td style="font-weight: 500;">
                        {{ item.product_name_es }}
                        {% if item.product.sku %}
                            <br><span style="font-size: 12px; color: var(--gray-500);">SKU: {{ item.product.sku }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">{{ item.quantity }}</td>
                    <td style="text-align: right;">{{ item.unit_price|currency_format }}</td>
                    <td style="text-align: right; font-weight: 600;">{{ item.line_total|currency_format }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray-500);">
                        {% trans "No hay productos en este pedido" %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Totales -->
    <div style="background-color: var(--gray-50); padding: 24px; border-top: 1px solid var(--gray-200);">
        <div style="max-width: 400px; margin-left: auto;">
            <dl style="display: grid; gap: 12px; margin: 0;">
                <div style="display: flex; justify-content: space-between;">
                    <dt style="color: var(--gray-600);">{% trans "Subtotal:" %}</dt>
                    <dd style="font-weight: 600; margin: 0;">{{ subtotal|currency_format }}</dd>
                </div>
                
                {% if shipping_cost > 0 %}
                <div style="display: flex; justify-content: space-between;">
                    <dt style="color: var(--gray-600);">{% trans "Gastos de Envío:" %}</dt>
                    <dd style="font-weight: 600; margin: 0;">{{ shipping_cost|currency_format }}</dd>
                </div>
                {% endif %}
                
                <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--gray-300);">
                    <dt style="font-size: 18px; font-weight: 600; color: var(--gray-900);">{% trans "Total:" %}</dt>
                    <dd style="font-size: 24px; font-weight: 700; color: var(--primary-600); margin: 0;">
                        {{ order.total_amount|currency_format }}
                    </dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- Historial del Pedido (solo si hay eventos) -->
{% if events %}
<div class="card no-print">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Historial del Pedido" %}</h5>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 16px;">
            {% for event in events %}
            <div style="display: flex; gap: 16px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    <i class="bi bi-check"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">{{ event.get_status_display }}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">
                        {{ event.created_at|date:"d/m/Y H:i" }}
                        {% if event.note %}
                            <br>{{ event.note }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Estilos para Impresión -->
<style>
    @media print {
        /* Ocultar elementos que no deben imprimirse */
        .no-print,
        .topbar,
        .topbar-left,
        .topbar-right,
        .topbar-actions,
        .global-search-wrapper,
        .language-selector-form,
        .topbar-cart-btn,
        nav,
        .btn,
        button,
        .sidebar,
        .navbar,
        header,
        footer {
            display: none !important;
        }
        
        /* Ajustar márgenes de página */
        @page {
            margin: 0.8cm;
        }
        
        body {
            background: white !important;
        }

        .main-content,
        .content-wrapper {
            padding: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        
        /* Asegurar que las cards no tengan sombra */
        .card {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            page-break-inside: avoid;
            margin-bottom: 12px !important;
        }

        .card-header,
        .card-body {
            padding: 12px !important;
        }
        
        /* Ajustar tamaños de fuente para impresión */
        .card-header h5 {
            font-size: 12px !important;
        }

        h2 {
            font-size: 20px !important;
        }

        p {
            margin-top: 4px !important;
        }

        .status-badge {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-size: 12px !important;
            padding: 4px 8px !important;
        }

        .card-body > div {
            gap: 16px !important;
        }

        dl {
            gap: 6px !important;
        }

        .table th,
        .table td {
            padding: 6px 8px !important;
            font-size: 11px !important;
        }

        .table {
            margin: 0 !important;
        }

        .table-wrapper {
            padding: 0 !important;
        }

        .card > div[style*="background-color"] {
            padding: 12px !important;
        }
        
        table {
            page-break-inside: auto;
        }
        
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        
        /* Asegurar que los colores de los badges se vean */
    }

    /* Modal de cancelacion - Estilos personalizados */
    .cancel-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 16px;
    }

    .cancel-modal-overlay.active {
        display: flex;
    }

    .cancel-modal-content {
        background: white;
        border-radius: 12px;
        padding: 32px 24px;
        max-width: 450px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .cancel-modal-icon {
        width: 60px;
        height: 60px;
        background: #fee2e2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 32px;
        color: #dc2626;
    }

    .cancel-modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--gray-900);
        text-align: center;
        margin-bottom: 12px;
    }

    .cancel-modal-text {
        font-size: 14px;
        color: var(--gray-600);
        text-align: center;
        margin-bottom: 32px;
        line-height: 1.5;
    }

    .cancel-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .cancel-modal-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        flex: 1;
        max-width: 180px;
    }

    .cancel-modal-btn-cancel {
        background: var(--gray-200);
        color: var(--gray-900);
    }

    .cancel-modal-btn-cancel:hover {
        background: var(--gray-300);
    }

    .cancel-modal-btn-confirm {
        background: #dc2626;
        color: white;
    }

    .cancel-modal-btn-confirm:hover {
        background: #b91c1c;
    }

    @media (max-width: 480px) {
        .cancel-modal-content {
            padding: 24px 16px;
        }

        .cancel-modal-title {
            font-size: 18px;
        }

        .cancel-modal-text {
            font-size: 13px;
            margin-bottom: 24px;
        }

        .cancel-modal-btn {
            max-width: none;
            padding: 12px 16px;
            font-size: 13px;
        }
    }
</style>

<!-- Modal de confirmacion de cancelacion -->
<div class="cancel-modal-overlay" id="cancelModal">
    <div class="cancel-modal-content">
        <div class="cancel-modal-icon">
            <i class="bi bi-exclamation-circle"></i>
        </div>
        <h3 class="cancel-modal-title">{% trans "¿Cancelar pedido?" %}</h3>
        <p class="cancel-modal-text">
            {% trans "Estás a punto de cancelar el pedido #" %}<strong>{{ order.id }}</strong>.<br>
            {% trans "Esta acción no se puede deshacer." %}
        </p>
        <div class="cancel-modal-actions">
            <button type="button" class="cancel-modal-btn cancel-modal-btn-cancel" onclick="closeCancelModal();">
                {% trans "No, mantener" %}
            </button>
            <form method="post" action="{% url 'orders:order_cancel' order.id %}" style="flex: 1; max-width: 180px;">
                {% csrf_token %}
                <button type="submit" class="cancel-modal-btn cancel-modal-btn-confirm" style="width: 100%;">
                    {% trans "Sí, cancelar" %}
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function openCancelModal() {
    document.getElementById('cancelModal').classList.add('active');
}

function closeCancelModal() {
    document.getElementById('cancelModal').classList.remove('active');
}

// Cerrar modal al hacer click fuera del contenido
document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCancelModal();
    }
});

// Cerrar modal con tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCancelModal();
    }
});
</script>
{% endblock %}
