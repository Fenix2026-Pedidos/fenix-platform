{% extends 'base.html' %}
{% load i18n %}
{% load orders_filters %}

{% block page_title %}{% trans "Pedido" %} #{{ order.id }}{% endblock %}
{% block title %}{% trans "Pedido" %} #{{ order.id }} - Fenix{% endblock %}

{% block content %}
<!-- Breadcrumb + Print Button -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <nav>
        <ol style="display: flex; list-style: none; padding: 0; gap: 8px; align-items: center;">
            <li><a href="{% url 'orders:order_list' %}" style="color: var(--primary-600); text-decoration: none;">{% trans "Mis Pedidos" %}</a></li>
            <li><i class="bi bi-chevron-right" style="color: var(--gray-400);"></i></li>
            <li style="color: var(--gray-600);">{% trans "Pedido" %} #{{ order.id }}</li>
        </ol>
    </nav>
    
    <button onclick="window.print()" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px;">
        <i class="bi bi-printer"></i>
        <span>{% trans "Imprimir" %}</span>
    </button>
</div>

<!-- Header: Order Number + Status -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 24px;">
        <div>
            <h2 style="margin: 0; font-size: 28px; color: var(--gray-900);">
                {% trans "Pedido" %} #{{ order.id }}
            </h2>
            <p style="margin: 8px 0 0 0; color: var(--gray-500);">
                {% trans "Fecha de creación:" %} {{ order.created_at|date:"d/m/Y H:i" }}
            </p>
        </div>
        <span class="status-badge status-{{ order.status }}" style="font-size: 16px; padding: 8px 16px;">
            {{ order.get_status_display }}
        </span>
    </div>
</div>

<!-- CARD: Información del Pedido (Cliente + Entrega + Datos Pedido) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Información del Pedido" %}</h5>
    </div>
    <div class="card-body" style="padding: 24px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
            <!-- COLUMNA IZQUIERDA: Cliente y Entrega -->
            <div>
                <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                    {% trans "INFORMACIÓN DEL CLIENTE" %}
                </h6>
                <dl style="display: grid; gap: 12px; margin: 0;">
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Cliente" %}
                        </dt>
                        <dd style="font-weight: 600; margin: 0;">
                            {{ customer.full_name|default:customer.get_full_name|default:"—" }}
                        </dd>
                    </div>
                    
                    {% if customer.company %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Empresa" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.company }}</dd>
                    </div>
                    {% endif %}
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Email" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.email }}</dd>
                    </div>
                    
                    {% if customer.telefono_empresa %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Teléfono Empresa" %}
                        </dt>
                        <dd style="margin: 0;">{{ customer.telefono_empresa }}</dd>
                    </div>
                    {% endif %}
                    
                    {% if customer.telefono_reparto %}
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Teléfono Reparto/Incidencias" %}
                        </dt>
                        <dd style="margin: 0; font-weight: 600; color: var(--primary-600);">
                            {{ customer.telefono_reparto }}
                        </dd>
                    </div>
                    {% endif %}
                </dl>
                
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--gray-200);">
                    <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                        {% trans "DIRECCIÓN DE ENTREGA" %}
                    </h6>
                    <dl style="display: grid; gap: 12px; margin: 0;">
                        {% if customer.ciudad %}
                        <div>
                            <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                {% trans "Ciudad" %}
                            </dt>
                            <dd style="margin: 0;">{{ customer.ciudad }}</dd>
                        </div>
                        {% endif %}
                        
                        {% if customer.direccion_entrega %}
                        <div>
                            <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                {% trans "Dirección" %}
                            </dt>
                            <dd style="margin: 0;">{{ customer.direccion_entrega }}</dd>
                        </div>
                        {% elif customer.direccion_local %}
                        <div>
                            <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                {% trans "Dirección" %}
                            </dt>
                            <dd style="margin: 0;">{{ customer.direccion_local }}</dd>
                        </div>
                        {% endif %}
                        
                        {% if order.eta_start and order.eta_end %}
                        <div>
                            <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                {% trans "Ventana de Entrega" %}
                            </dt>
                            <dd style="margin: 0;">
                                {{ order.eta_start|date:"d/m/Y H:i" }} - {{ order.eta_end|date:"H:i" }}
                            </dd>
                        </div>
                        {% endif %}
                    </dl>
                </div>
            </div>
            
            <!-- COLUMNA DERECHA: Datos del Pedido -->
            <div>
                <h6 style="font-size: 12px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; font-weight: 600;">
                    {% trans "DATOS DEL PEDIDO" %}
                </h6>
                <dl style="display: grid; gap: 12px; margin: 0;">
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Nº Pedido / ID" %}
                        </dt>
                        <dd style="font-weight: 600; color: var(--primary-600); font-size: 18px; margin: 0;">
                            #{{ order.id }}
                        </dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Fecha de Creación" %}
                        </dt>
                        <dd style="margin: 0;">{{ order.created_at|date:"d/m/Y H:i" }}</dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Fecha de Entrega" %}
                        </dt>
                        <dd style="margin: 0;">
                            {% if order.delivered_at %}
                                {{ order.delivered_at|date:"d/m/Y H:i" }}
                            {% else %}
                                <span style="color: var(--gray-400);">—</span>
                            {% endif %}
                        </dd>
                    </div>
                    
                    <div>
                        <dt style="font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                            {% trans "Estado" %}
                        </dt>
                        <dd style="margin: 0;">
                            <span class="status-badge status-{{ order.status }}">
                                {{ order.get_status_display }}
                            </span>
                        </dd>
                    </div>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- CARD: Detalles del Pedido (Tabla de Líneas) -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Detalles del Pedido" %}</h5>
    </div>
    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th style="text-align: center;">{% trans "ID Pedido" %}</th>
                    <th>{% trans "Producto" %}</th>
                    <th style="text-align: center;">{% trans "Cantidad" %}</th>
                    <th style="text-align: right;">{% trans "Precio Unitario" %}</th>
                    <th style="text-align: right;">{% trans "Total Línea" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td style="text-align: center; color: var(--gray-500); font-size: 13px;">
                        #{{ order.id }}
                    </td>
                    <td style="font-weight: 500;">
                        {{ item.product_name_es }}
                        {% if item.product.sku %}
                            <br><span style="font-size: 12px; color: var(--gray-500);">SKU: {{ item.product.sku }}</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">{{ item.quantity }}</td>
                    <td style="text-align: right;">{{ item.unit_price|currency_format }}</td>
                    <td style="text-align: right; font-weight: 600;">{{ item.line_total|currency_format }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray-500);">
                        {% trans "No hay productos en este pedido" %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Totales -->
    <div style="background-color: var(--gray-50); padding: 24px; border-top: 1px solid var(--gray-200);">
        <div style="max-width: 400px; margin-left: auto;">
            <dl style="display: grid; gap: 12px; margin: 0;">
                <div style="display: flex; justify-content: space-between;">
                    <dt style="color: var(--gray-600);">{% trans "Subtotal:" %}</dt>
                    <dd style="font-weight: 600; margin: 0;">{{ subtotal|currency_format }}</dd>
                </div>
                
                {% if shipping_cost > 0 %}
                <div style="display: flex; justify-content: space-between;">
                    <dt style="color: var(--gray-600);">{% trans "Gastos de Envío:" %}</dt>
                    <dd style="font-weight: 600; margin: 0;">{{ shipping_cost|currency_format }}</dd>
                </div>
                {% endif %}
                
                <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 2px solid var(--gray-300);">
                    <dt style="font-size: 18px; font-weight: 600; color: var(--gray-900);">{% trans "Total:" %}</dt>
                    <dd style="font-size: 24px; font-weight: 700; color: var(--primary-600); margin: 0;">
                        {{ order.total_amount|currency_format }}
                    </dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- Historial del Pedido (solo si hay eventos) -->
{% if events %}
<div class="card no-print">
    <div class="card-header">
        <h5 class="card-title" style="margin: 0;">{% trans "Historial del Pedido" %}</h5>
    </div>
    <div class="card-body">
        <div style="display: flex; flex-direction: column; gap: 16px;">
            {% for event in events %}
            <div style="display: flex; gap: 16px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0;">
                    <i class="bi bi-check"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">{{ event.get_status_display }}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">
                        {{ event.created_at|date:"d/m/Y H:i" }}
                        {% if event.note %}
                            <br>{{ event.note }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Estilos para Impresión -->
<style>
    @media print {
        /* Ocultar elementos que no deben imprimirse */
        .no-print,
        nav,
        .btn,
        button,
        .sidebar,
        .navbar,
        header,
        footer {
            display: none !important;
        }
        
        /* Ajustar márgenes de página */
        @page {
            margin: 1.5cm;
        }
        
        body {
            background: white !important;
        }
        
        /* Asegurar que las cards no tengan sombra */
        .card {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            page-break-inside: avoid;
        }
        
        /* Ajustar tamaños de fuente para impresión */
        .card-header h5 {
            font-size: 14px !important;
        }
        
        table {
            page-break-inside: auto;
        }
        
        tr {
            page-break-inside: avoid;
            page-break-after: auto;
        }
        
        /* Asegurar que los colores de los badges se vean */
        .status-badge {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>
{% endblock %}
