{% load i18n %}
<div class="topbar">
    <div class="topbar-left">
        <!-- Buscador Global Inteligente -->
        <div class="global-search-wrapper">
            <i class="bi bi-search search-icon"></i>
            <input 
                type="search" 
                class="global-search-input" 
                placeholder="{% trans 'ðŸ” Buscar pedidos, productos o accionesâ€¦' %}" 
                id="globalSearchInput"
                autocomplete="off"
            >
        </div>
    </div>
    
    <div class="topbar-right">
        <div class="topbar-actions">
            <!-- Selector de idioma -->
            <form action="{% url 'set_language' %}" method="post" class="language-selector-form" id="language-form">
                {% csrf_token %}
                <input name="next" type="hidden" value="{{ request.get_full_path }}">
                <select name="language" onchange="this.form.submit()" class="language-select">
                    {% get_current_language as CURRENT_LANGUAGE %}
                    {% get_available_languages as LANGUAGES_LIST %}
                    {% for lang_code, lang_name in LANGUAGES_LIST %}
                        {% if lang_code != 'en' %}
                        <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                            {% if lang_code == 'es' %}ðŸ‡ªðŸ‡¸ EspaÃ±ol
                            {% elif lang_code == 'zh-hans' %}ðŸ‡¨ðŸ‡³ ä¸­æ–‡
                            {% else %}{{ lang_name }}{% endif %}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </form>
            
            {% if user.is_authenticated %}
            <!-- Carrito minimalista estilo Amazon -->
            <a href="{% url 'orders:cart' %}" 
               class="topbar-cart-btn fenix-cart-minimal" 
               id="topbarCartBtn"
               aria-label="{% if cart_count > 0 %}{% trans 'Carrito' %} ({{ cart_count }}){% else %}{% trans 'Carrito' %}{% endif %}"
               title="{% if cart_count > 0 %}{% trans 'Carrito' %} ({{ cart_count }}){% else %}{% trans 'Carrito' %}{% endif %}">
                <span class="topbar-cart-icon">ðŸ›’</span>
                <span class="topbar-cart-badge" id="topbarCartBadge" data-count="{{ cart_count|default:0 }}" {% if cart_count|default:0 == 0 %}style="display: none;"{% endif %}>
                    {% if cart_count > 0 %}{{ cart_count }}{% endif %}
                </span>
            </a>
            
            <!-- Perfil de usuario -->
            <div class="dropdown" id="userDropdownContainer" style="position: relative;">
            <button class="btn btn-outline user-dropdown-btn" type="button" id="userDropdown">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">
                        {{ user.full_name|first|default:user.email|first|upper }}
                    </div>
                    <span class="d-none d-md-inline" style="white-space: nowrap;">{{ user.full_name|default:user.email|truncatechars:20 }}</span>
                    <i class="bi bi-chevron-down" style="flex-shrink: 0; font-size: 12px;"></i>
                </div>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu" style="display: none; position: absolute; top: calc(100% + 8px); right: 0; background: white; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 8px 0; min-width: 200px; z-index: 1000; list-style: none; margin: 0;">
                <li style="list-style: none;">
                    <a class="dropdown-item" href="{% url 'accounts:profile' %}" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition);">
                        <i class="bi bi-person"></i> {% trans "Mi Perfil" %}
                    </a>
                </li>
                <li style="list-style: none;"><hr class="dropdown-divider" style="margin: 8px 0; border-top: 1px solid var(--gray-200); border-bottom: none;"></li>
                <li style="list-style: none;">
                    <form method="post" action="{% url 'accounts:logout' %}" class="dropdown-item p-0 m-0" style="display: block;">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item w-100 text-start" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition); border: none; background: none; width: 100%; text-align: left; cursor: pointer;">
                            <i class="bi bi-box-arrow-right"></i> {% trans "Cerrar SesiÃ³n" %}
                        </button>
                    </form>
                </li>
            </ul>
            </div>
            {% else %}
            <a href="{% url 'accounts:login' %}" class="btn btn-outline btn-sm">
                {% trans "Iniciar SesiÃ³n" %}
            </a>
            <a href="{% url 'accounts:register' %}" class="btn btn-primary btn-sm">
                {% trans "Registrarse" %}
            </a>
            {% endif %}
        </div>
        
        <script>
        // Toggle dropdown manual
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownBtn = document.getElementById('userDropdown');
            const dropdownMenu = document.getElementById('userDropdownMenu');
            const dropdownContainer = document.getElementById('userDropdownContainer');
            
            if (dropdownBtn && dropdownMenu && dropdownContainer) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = dropdownMenu.style.display === 'block';
                    dropdownMenu.style.display = isOpen ? 'none' : 'block';
                    dropdownContainer.classList.toggle('show', !isOpen);
                });
                
                // Cerrar al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (dropdownContainer && !dropdownContainer.contains(e.target)) {
                        dropdownMenu.style.display = 'none';
                        dropdownContainer.classList.remove('show');
                    }
                });
            }
        });
        </script>
    </div>
</div>
<!-- CSRF logout fallback -->
<script>
(function(){
  function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
  document.addEventListener('click', function(e){
    const btn = e.target.closest('form[action$="/accounts/logout/"] button[type="submit"], form[action$="/accounts/logout/"] input[type="submit"]');
    if (btn) {
      const form = btn.form;
      if (form && !form.querySelector('input[name="csrfmiddlewaretoken"]')) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = getCookie('csrftoken');
        form.appendChild(input);
      }
    }
  }, true);
})();
</script>
<!-- CSRF logout fallback end -->

<!-- Global Search Script -->
<script>
(function() {
  const searchInput = document.getElementById('globalSearchInput');
  if (!searchInput) return;
  
  // Preparado para bÃºsqueda inteligente (por implementar)
  searchInput.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    // TODO: Implementar bÃºsqueda en tiempo real
    // - BÃºsqueda de pedidos por nÃºmero
    // - BÃºsqueda de productos por nombre
    // - BÃºsqueda de acciones pendientes
    // - Sugerencias inteligentes con dropdown
    
    if (query.length >= 3) {
      console.log('Buscando:', query);
      // AquÃ­ se agregarÃ¡n llamadas AJAX/Fetch para bÃºsqueda en tiempo real
    }
  });
  
  // Atajos de teclado (Ctrl+K o Cmd+K para enfocar bÃºsqueda)
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      searchInput.focus();
    }
  });
})();
</script>
<!-- End Global Search Script -->
