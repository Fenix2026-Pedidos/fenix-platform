{% load i18n %}
<div class="topbar">
    <div class="topbar-left">
        <button class="btn btn-sm btn-outline d-md-none" id="mobile-menu-toggle" style="border: none; background: transparent; color: var(--gray-700);">
            <i class="bi bi-list" style="font-size: 20px;"></i>
        </button>
        <h1 class="topbar-title">{% block page_title %}{% trans "Dashboard" %}{% endblock %}</h1>
    </div>
    
    <div class="topbar-right">
        <!-- Selector de idioma -->
        <form action="{% url 'set_language' %}" method="post" class="language-selector-form" id="language-form">
            {% csrf_token %}
            <input name="next" type="hidden" value="{{ request.get_full_path }}">
            <select name="language" onchange="this.form.submit()" class="language-select">
                {% get_current_language as CURRENT_LANGUAGE %}
                {% get_available_languages as LANGUAGES_LIST %}
                {% for lang_code, lang_name in LANGUAGES_LIST %}
                    {% if lang_code != 'en' %}
                    <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                        {% if lang_code == 'es' %}ðŸ‡ªðŸ‡¸ EspaÃ±ol
                        {% elif lang_code == 'zh-hans' %}ðŸ‡¨ðŸ‡³ ä¸­æ–‡
                        {% else %}{{ lang_name }}{% endif %}
                    </option>
                    {% endif %}
                {% endfor %}
            </select>
        </form>
        
        {% if user.is_authenticated %}
        <div class="dropdown" id="userDropdownContainer" style="position: relative;">
            <button class="btn btn-outline user-dropdown-btn" type="button" id="userDropdown">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">
                        {{ user.full_name|first|default:user.email|first|upper }}
                    </div>
                    <span class="d-none d-md-inline" style="white-space: nowrap;">{{ user.full_name|default:user.email|truncatechars:20 }}</span>
                    <i class="bi bi-chevron-down" style="flex-shrink: 0; font-size: 12px;"></i>
                </div>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu" style="display: none; position: absolute; top: calc(100% + 8px); right: 0; background: white; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 8px 0; min-width: 200px; z-index: 1000; list-style: none; margin: 0;">
                <li style="list-style: none;">
                    <a class="dropdown-item" href="{% url 'accounts:profile' %}" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition);">
                        <i class="bi bi-person"></i> {% trans "Mi Perfil" %}
                    </a>
                </li>
                <li style="list-style: none;"><hr class="dropdown-divider" style="margin: 8px 0; border-top: 1px solid var(--gray-200); border-bottom: none;"></li>
                <li style="list-style: none;">
                    <a class="dropdown-item" href="{% url 'accounts:logout' %}" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition);">
                        <i class="bi bi-box-arrow-right"></i> {% trans "Cerrar SesiÃ³n" %}
                    </a>
                </li>
            </ul>
        </div>
        
        <script>
        // Toggle dropdown manual
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownBtn = document.getElementById('userDropdown');
            const dropdownMenu = document.getElementById('userDropdownMenu');
            const dropdownContainer = document.getElementById('userDropdownContainer');
            
            if (dropdownBtn && dropdownMenu && dropdownContainer) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = dropdownMenu.style.display === 'block';
                    dropdownMenu.style.display = isOpen ? 'none' : 'block';
                    dropdownContainer.classList.toggle('show', !isOpen);
                });
                
                // Cerrar al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (dropdownContainer && !dropdownContainer.contains(e.target)) {
                        dropdownMenu.style.display = 'none';
                        dropdownContainer.classList.remove('show');
                    }
                });
            }
        });
        </script>
        {% else %}
        <a href="{% url 'accounts:login' %}" class="btn btn-outline btn-sm">
            {% trans "Iniciar SesiÃ³n" %}
        </a>
        <a href="{% url 'accounts:register' %}" class="btn btn-primary btn-sm">
            {% trans "Registrarse" %}
        </a>
        {% endif %}
    </div>
</div>
