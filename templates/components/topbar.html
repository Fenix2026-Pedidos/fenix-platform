{% load i18n static %}
<div class="topbar">

    <div class="topbar-left">
        <!-- Buscador Global Inteligente -->
        <div class="global-search-wrapper">
            <i class="bi bi-search search-icon"></i>
            <input 
                type="search" 
                class="global-search-input" 
                placeholder="{% trans 'ðŸ” Buscar pedidos, productos o accionesâ€¦' %}" 
                id="globalSearchInput"
                autocomplete="off"
            >
            <div class="global-search-results" id="globalSearchResults" hidden></div>
        </div>
    </div>
    
    <div class="topbar-right">
        <div class="topbar-actions">
            <!-- Selector de idioma -->
            <form action="{% url 'set_language' %}" method="post" class="language-selector-form" id="language-form">
                {% csrf_token %}
                <input name="next" type="hidden" value="{{ request.get_full_path }}">
                <select name="language" onchange="this.form.submit()" class="language-select">
                    {% get_current_language as CURRENT_LANGUAGE %}
                    {% get_available_languages as LANGUAGES_LIST %}
                    {% for lang_code, lang_name in LANGUAGES_LIST %}
                        {% if lang_code != 'en' %}
                        <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                            {% if lang_code == 'es' %}ðŸ‡ªðŸ‡¸ EspaÃ±ol
                            {% elif lang_code == 'zh-hans' %}ðŸ‡¨ðŸ‡³ ä¸­æ–‡
                            {% else %}{{ lang_name }}{% endif %}
                        </option>
                        {% endif %}
                    {% endfor %}
                </select>
            </form>
            
            {% if user.is_authenticated %}
            <!-- Carrito minimalista estilo Amazon -->
            <a href="{% url 'orders:cart' %}" 
               class="topbar-cart-btn fenix-cart-minimal" 
               id="topbarCartBtn"
               aria-label="{% if cart_count > 0 %}{% trans 'Carrito' %} ({{ cart_count }}){% else %}{% trans 'Carrito' %}{% endif %}"
               title="{% if cart_count > 0 %}{% trans 'Carrito' %} ({{ cart_count }}){% else %}{% trans 'Carrito' %}{% endif %}">
                <span class="topbar-cart-icon">ðŸ›’</span>
                <span class="topbar-cart-badge" id="topbarCartBadge" data-count="{{ cart_count|default:0 }}" {% if cart_count|default:0 == 0 %}style="display: none;"{% endif %}>
                    {% if cart_count > 0 %}{{ cart_count }}{% endif %}
                </span>
            </a>
            
            <!-- Perfil de usuario -->
            <div class="dropdown" id="userDropdownContainer" style="position: relative;">
            <button class="btn btn-outline user-dropdown-btn" type="button" id="userDropdown">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0;">
                        {{ user.full_name|first|default:user.email|first|upper }}
                    </div>
                    <span class="d-none d-md-inline" style="white-space: nowrap; display: flex; flex-direction: column; align-items: flex-start; line-height: 1.1;">
                        <span style="font-weight: 600; color: var(--gray-900);">{{ user.full_name|default:user.email|truncatechars:20 }}</span>
                        <span style="font-size: 12px; color: var(--gray-500);">
                            {% if user_company and user_company.job_title %}
                                {{ user_company.job_title }}
                            {% endif %}
                        </span>
                    </span>
                    <i class="bi bi-chevron-down" style="flex-shrink: 0; font-size: 12px;"></i>
                </div>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="userDropdownMenu" style="display: none; position: absolute; top: calc(100% + 8px); right: 0; background: white; border: 1px solid var(--gray-200); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 8px 0; min-width: 200px; z-index: 1000; list-style: none; margin: 0;">
                <li style="list-style: none;">
                    <a class="dropdown-item" href="{% url 'accounts:profile' %}" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition);">
                        <i class="bi bi-person"></i> {% trans "Mi Perfil" %}
                    </a>
                </li>
                <li style="list-style: none;"><hr class="dropdown-divider" style="margin: 8px 0; border-top: 1px solid var(--gray-200); border-bottom: none;"></li>
                <li style="list-style: none;">
                    <form method="post" action="{% url 'accounts:logout' %}" class="dropdown-item p-0 m-0" style="display: block;">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item w-100 text-start" style="display: block; padding: 8px 16px; color: var(--gray-700); text-decoration: none; font-size: 14px; transition: background-color var(--transition); border: none; background: none; width: 100%; text-align: left; cursor: pointer;">
                            <i class="bi bi-box-arrow-right"></i> {% trans "Cerrar SesiÃ³n" %}
                        </button>
                    </form>
                </li>
            </ul>
            </div>
            {% else %}
            <a href="{% url 'accounts:login' %}" class="btn btn-outline btn-sm">
                {% trans "Iniciar SesiÃ³n" %}
            </a>
            <a href="{% url 'accounts:register' %}" class="btn btn-primary btn-sm">
                {% trans "Registrarse" %}
            </a>
            {% endif %}
        </div>
        
        <script>
        // Toggle dropdown manual
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownBtn = document.getElementById('userDropdown');
            const dropdownMenu = document.getElementById('userDropdownMenu');
            const dropdownContainer = document.getElementById('userDropdownContainer');
            
            if (dropdownBtn && dropdownMenu && dropdownContainer) {
                dropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = dropdownMenu.style.display === 'block';
                    dropdownMenu.style.display = isOpen ? 'none' : 'block';
                    dropdownContainer.classList.toggle('show', !isOpen);
                });
                
                // Cerrar al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (dropdownContainer && !dropdownContainer.contains(e.target)) {
                        dropdownMenu.style.display = 'none';
                        dropdownContainer.classList.remove('show');
                    }
                });
            }
        });
        </script>
    </div>
</div>
<!-- CSRF logout fallback -->
<script>
(function(){
  function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
  document.addEventListener('click', function(e){
    const btn = e.target.closest('form[action$="/accounts/logout/"] button[type="submit"], form[action$="/accounts/logout/"] input[type="submit"]');
    if (btn) {
      const form = btn.form;
      if (form && !form.querySelector('input[name="csrfmiddlewaretoken"]')) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = getCookie('csrftoken');
        form.appendChild(input);
      }
    }
  }, true);
})();
</script>
<!-- CSRF logout fallback end -->

<!-- Global Search Script -->
<script>
(function() {
    const searchInput = document.getElementById('globalSearchInput');
    const resultsPanel = document.getElementById('globalSearchResults');
    const wrapper = searchInput ? searchInput.closest('.global-search-wrapper') : null;
    if (!searchInput || !resultsPanel || !wrapper) return;

    const MIN_QUERY_LENGTH = 2;
    const searchEndpoint = "{% url 'global_search' %}";
    const labels = {
        orders: "{{ _('Mis Pedidos')|escapejs }}",
        products: "{{ _('Productos')|escapejs }}",
        actions: "{{ _('Acciones Pendientes')|escapejs }}",
        empty: "{{ _('No se encontraron resultados')|escapejs }}",
        hint: "{{ _('Escribe al menos 2 caracteres para buscar')|escapejs }}",
        error: "{{ _('Ha ocurrido un error')|escapejs }}",
        loading: "{{ _('Cargando...')|escapejs }}",
    };

    let debounceTimer = null;
    let activeController = null;
    let lastResults = [];
    let currentQuery = '';

    const escapeHtml = (value = '') => value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const hideResults = () => {
        resultsPanel.hidden = true;
    };

    const showMessage = (message) => {
        resultsPanel.innerHTML = `<div class="search-empty">${escapeHtml(message)}</div>`;
        resultsPanel.hidden = false;
    };

    const renderResults = (results, query) => {
        lastResults = [];
        const sections = [];
        const headingMap = {
            orders: labels.orders,
            products: labels.products,
            actions: labels.actions,
        };

        ['orders', 'products', 'actions'].forEach((type) => {
            const items = results?.[type] || [];
            if (!items.length) {
                return;
            }

            lastResults = lastResults.concat(items);

            const itemsMarkup = items.map((item) => `
                <li class="search-result-item">
                    <a class="search-result-link" href="${item.url}">
                        <span class="result-title">${escapeHtml(item.title)}</span>
                        ${item.subtitle ? `<span class="result-subtitle">${escapeHtml(item.subtitle)}</span>` : ''}
                    </a>
                </li>
            `).join('');

            sections.push(`
                <div class="search-section">
                    <p class="search-section-title">${headingMap[type]}</p>
                    <ul class="search-results-list">${itemsMarkup}</ul>
                </div>
            `);
        });

        if (!sections.length) {
            showMessage(labels.empty);
            return;
        }

        resultsPanel.innerHTML = sections.join('');
        resultsPanel.hidden = false;
    };

    const performSearch = (query) => {
        currentQuery = query;
        if (activeController) {
            activeController.abort();
        }
        activeController = new AbortController();

        showMessage(labels.loading);

        fetch(`${searchEndpoint}?q=${encodeURIComponent(query)}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin',
            signal: activeController.signal,
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Response not OK');
                }
                return response.json();
            })
            .then((data) => {
                if (query !== currentQuery) {
                    return;
                }
                renderResults(data?.results, query);
            })
            .catch((error) => {
                if (error.name === 'AbortError') {
                    return;
                }
                console.error('Global search error', error);
                showMessage(labels.error);
            });
    };

    searchInput.addEventListener('input', (event) => {
        const value = event.target.value.trim();
        clearTimeout(debounceTimer);

        if (!value) {
            currentQuery = '';
            lastResults = [];
            hideResults();
            return;
        }

        if (value.length < MIN_QUERY_LENGTH) {
            showMessage(labels.hint);
            return;
        }

        debounceTimer = setTimeout(() => performSearch(value), 250);
    });

    searchInput.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
            event.preventDefault();
            searchInput.focus();
            return;
        }

        if (event.key === 'Escape') {
            hideResults();
            searchInput.blur();
            return;
        }

        if (event.key === 'Enter' && lastResults.length) {
            window.location.href = lastResults[0].url;
        }
    });

    searchInput.addEventListener('focus', () => {
        if (resultsPanel.innerHTML.trim()) {
            resultsPanel.hidden = false;
        }
    });

    searchInput.addEventListener('blur', () => {
        setTimeout(() => hideResults(), 120);
    });

    document.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
            event.preventDefault();
            searchInput.focus();
        }
    });

    document.addEventListener('click', (event) => {
        if (!wrapper.contains(event.target)) {
            hideResults();
        }
    });
})();
</script>
<!-- End Global Search Script -->
