{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Perfil Operativo" %} - Fenix{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto px-4 py-8">
    
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">{% trans "Completar Perfil Operativo" %}</h1>
        <p class="text-gray-600">{% trans "Estos datos son necesarios para poder realizar pedidos en la plataforma." %}</p>
    </div>

    <!-- ⚠️ BANNER DE PERFIL INCOMPLETO -->
    {% if not form.instance.profile_completed %}
    <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
        <div class="flex gap-3">
            <div class="flex-shrink-0">
                <i class="bi bi-exclamation-triangle-fill text-yellow-600 text-xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-yellow-800 mb-2">
                    {% trans "Tu perfil está incompleto" %}
                </h3>
                <p class="text-yellow-700 text-sm mb-3">
                    {% trans "Debes completar los siguientes campos obligatorios para poder realizar pedidos:" %}
                </p>
                <ul class="text-yellow-700 text-sm space-y-1">
                    {% for field_name in form.instance.missing_fields %}
                    <li class="flex items-center gap-2">
                        <i class="bi bi-dash"></i>
                        {{ field_name }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% else %}
    <!-- ✅ PERFIL COMPLETADO -->
    <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-400 rounded-lg">
        <div class="flex gap-3">
            <div class="flex-shrink-0">
                <i class="bi bi-check-circle-fill text-green-600 text-xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-green-800">
                    {% trans "✓ Tu perfil está completo" %}
                </h3>
                <p class="text-green-700 text-sm mt-1">
                    {% trans "Puedes realizar pedidos en la plataforma." %}
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- FORMULARIO -->
    <form method="post" class="space-y-8">
        {% csrf_token %}

        <!-- ========== BLOQUE 1: CONTACTO ========== -->
        <fieldset class="border border-gray-200 rounded-lg p-6">
            <legend class="text-lg font-semibold text-gray-900 px-2">
                <i class="bi bi-telephone mr-2"></i>{% trans "1. Datos de Contacto" %}
            </legend>

            <div class="mt-4 space-y-4">
                <!-- Teléfono Empresa -->
                <div>
                    <label for="{{ form.telefono_empresa.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.telefono_empresa.label }}
                    </label>
                    {{ form.telefono_empresa }}
                    {% if form.telefono_empresa.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.telefono_empresa.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Teléfono Reparto (OBLIGATORIO) -->
                <div>
                    <label for="{{ form.telefono_reparto.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.telefono_reparto.label }}
                    </label>
                    {{ form.telefono_reparto }}
                    {% if form.telefono_reparto.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.telefono_reparto.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if form.telefono_reparto.help_text %}
                    <p class="text-gray-500 text-xs mt-1">{{ form.telefono_reparto.help_text|safe }}</p>
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- ========== BLOQUE 2: DIRECCIÓN FISCAL/LOCAL ========== -->
        <fieldset class="border border-gray-200 rounded-lg p-6">
            <legend class="text-lg font-semibold text-gray-900 px-2">
                <i class="bi bi-building mr-2"></i>{% trans "2. Dirección Local/Fiscal" %}
            </legend>

            <div class="mt-4 space-y-4">
                <!-- Dirección -->
                <div>
                    <label for="{{ form.direccion_local.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.direccion_local.label }}
                    </label>
                    {{ form.direccion_local }}
                    {% if form.direccion_local.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.direccion_local.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Fila: Ciudad, Provincia -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ciudad -->
                    <div>
                        <label for="{{ form.ciudad.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.ciudad.label }}
                        </label>
                        {{ form.ciudad }}
                        {% if form.ciudad.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.ciudad.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Provincia -->
                    <div>
                        <label for="{{ form.provincia.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.provincia.label }}
                        </label>
                        {{ form.provincia }}
                        {% if form.provincia.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.provincia.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Fila: Código Postal, País -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Código Postal -->
                    <div>
                        <label for="{{ form.codigo_postal.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.codigo_postal.label }}
                        </label>
                        {{ form.codigo_postal }}
                        {% if form.codigo_postal.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.codigo_postal.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- País -->
                    <div>
                        <label for="{{ form.pais.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.pais.label }}
                        </label>
                        {{ form.pais }}
                        {% if form.pais.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.pais.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- ========== BLOQUE 3: DIRECCIÓN DE ENTREGA ========== -->
        <fieldset class="border border-gray-200 rounded-lg p-6">
            <legend class="text-lg font-semibold text-gray-900 px-2">
                <i class="bi bi-truck mr-2"></i>{% trans "3. Dirección de Entrega" %}
            </legend>

            <div class="mt-4 space-y-4">
                <!-- Tipo de Entrega -->
                <div>
                    <label for="{{ form.tipo_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.tipo_entrega.label }}
                    </label>
                    {{ form.tipo_entrega }}
                    {% if form.tipo_entrega.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.tipo_entrega.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if form.tipo_entrega.help_text %}
                    <p class="text-gray-500 text-xs mt-1">{{ form.tipo_entrega.help_text|safe }}</p>
                    {% endif %}
                </div>

                <!-- Dirección de Entrega -->
                <div>
                    <label for="{{ form.direccion_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.direccion_entrega.label }}
                    </label>
                    {{ form.direccion_entrega }}
                    {% if form.direccion_entrega.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.direccion_entrega.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Fila: Ciudad, Provincia Entrega -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Ciudad Entrega -->
                    <div>
                        <label for="{{ form.ciudad_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.ciudad_entrega.label }}
                        </label>
                        {{ form.ciudad_entrega }}
                        {% if form.ciudad_entrega.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.ciudad_entrega.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Provincia Entrega -->
                    <div>
                        <label for="{{ form.provincia_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            {{ form.provincia_entrega.label }}
                        </label>
                        {{ form.provincia_entrega }}
                        {% if form.provincia_entrega.errors %}
                        <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {% for error in form.provincia_entrega.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Fila: Código Postal Entrega -->
                <div>
                    <label for="{{ form.codigo_postal_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.codigo_postal_entrega.label }}
                    </label>
                    {{ form.codigo_postal_entrega }}
                    {% if form.codigo_postal_entrega.errors %}
                    <div class="text-red-500 text-sm mt-1 flex items-center gap-1">
                        <i class="bi bi-exclamation-circle"></i>
                        {% for error in form.codigo_postal_entrega.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Ventana de Entrega (Opcional) -->
                <div>
                    <label for="{{ form.ventana_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.ventana_entrega.label }}
                    </label>
                    {{ form.ventana_entrega }}
                    {% if form.ventana_entrega.help_text %}
                    <p class="text-gray-500 text-xs mt-1">{{ form.ventana_entrega.help_text|safe }}</p>
                    {% endif %}
                </div>

                <!-- Observaciones (Opcional) -->
                <div>
                    <label for="{{ form.observaciones_entrega.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.observaciones_entrega.label }}
                    </label>
                    {{ form.observaciones_entrega }}
                </div>
            </div>
        </fieldset>

        <!-- ERRORES NO-FIELD -->
        {% if form.non_field_errors %}
        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
            {% for error in form.non_field_errors %}
            <div class="text-red-700 text-sm flex items-center gap-2 mb-2">
                <i class="bi bi-exclamation-circle"></i>
                {{ error }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- BOTONES DE ACCIÓN -->
        <div class="flex gap-3 justify-between">
            <a href="{% url 'accounts:profile_view' %}" class="px-6 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                {% trans "Cancelar" %}
            </a>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="bi bi-check-lg mr-2"></i>{% trans "Guardar Perfil" %}
            </button>
        </div>
    </form>

    <!-- INFO ADICIONAL -->
    <div class="mt-12 p-6 bg-gray-50 rounded-lg border border-gray-200">
        <h3 class="font-semibold text-gray-900 mb-3">
            <i class="bi bi-info-circle mr-2"></i>{% trans "¿Por qué solicitamos estos datos?" %}
        </h3>
        <ul class="text-gray-700 text-sm space-y-2">
            <li class="flex gap-2">
                <span class="text-blue-600 font-semibold">•</span>
                {% trans "Para poder contactar contigo en caso de incidencias en el reparto" %}
            </li>
            <li class="flex gap-2">
                <span class="text-blue-600 font-semibold">•</span>
                {% trans "Para gestionar correctamente la entrega de tus pedidos" %}
            </li>
            <li class="flex gap-2">
                <span class="text-blue-600 font-semibold">•</span>
                {% trans "Para cumplir con normativas de facturación y logística" %}
            </li>
        </ul>
    </div>
</div>

<style>
    /* Mejorar appearance de inputs con TailwindCSS */
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    select,
    textarea {
        transition: all 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus,
    select:focus,
    textarea:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Marcar campos con error */
    .errorlist {
        display: none;
    }

    input.is-invalid,
    select.is-invalid,
    textarea.is-invalid {
        border-color: #ef4444 !important;
        background-color: #fef2f2;
    }
</style>
{% endblock %}
